<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Convert pdqr-functions with `as_*()` • pdqr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/united/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<script src="../extra.js"></script><meta property="og:title" content="Convert pdqr-functions with `as_*()`">
<meta property="og:description" content="pdqr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">pdqr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.3.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/pdqr-01-create.html">Create pdqr-functions with `new_*()`</a>
    </li>
    <li>
      <a href="../articles/pdqr-02-convert.html">Convert pdqr-functions with `as_*()`</a>
    </li>
    <li>
      <a href="../articles/pdqr-03-transform.html">Transform pdqr-functions with `form_*()` and base operations</a>
    </li>
    <li>
      <a href="../articles/pdqr-04-summarize.html">Summarize pdqr-functions with `summ_*()`</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/echasnovski/pdqr/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="pdqr-02-convert_files/header-attrs-2.6/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Convert pdqr-functions with <code>as_*()</code>
</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/echasnovski/pdqr/blob/master/vignettes/pdqr-02-convert.Rmd"><code>vignettes/pdqr-02-convert.Rmd</code></a></small>
      <div class="hidden name"><code>pdqr-02-convert.Rmd</code></div>

    </div>

    
    
<p>Family of <code>as_*()</code> functions should be used to convert existing distribution functions into desired class (“p”, “d”, “q”, or “r”). Roughly, this is a <code>new_*()</code> family but with function as an input.</p>
<p>There are two main use cases:</p>
<ul>
<li>Convert existing pdqr-functions to different type.</li>
<li>Convert (create) pdqr-function based on some other user-supplied distribution function.</li>
</ul>
<div id="existing-pdqr-functions" class="section level2">
<h2 class="hasAnchor">
<a href="#existing-pdqr-functions" class="anchor"></a>Existing pdqr-functions</h2>
<p>Converting existing pdqr-function to desired type is done straightforwardly by changing function’s class without touching the underlying distribution (“x_tbl” metadata is the same):</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r"><code class = "r">
<code class="sourceCode R"><span class="va">d_fin</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/new_p.html">new_d</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, <span class="st">"discrete"</span><span class="op">)</span>

<span class="fu"><a href="../reference/meta.html">meta_x_tbl</a></span><span class="op">(</span><span class="va">d_fin</span><span class="op">)</span>
<span class="co">#&gt;   x prob cumprob</span>
<span class="co">#&gt; 1 1 0.25    0.25</span>
<span class="co">#&gt; 2 2 0.25    0.50</span>
<span class="co">#&gt; 3 3 0.25    0.75</span>
<span class="co">#&gt; 4 4 0.25    1.00</span>

<span class="co"># This is equivalent to `new_p(1:4, "discrete")`</span>
<span class="op">(</span><span class="va">p_fin</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as_p.html">as_p</a></span><span class="op">(</span><span class="va">d_fin</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Cumulative distribution function of discrete type</span>
<span class="co">#&gt; Support: [1, 4] (4 elements)</span>
<span class="fu"><a href="../reference/meta.html">meta_x_tbl</a></span><span class="op">(</span><span class="va">p_fin</span><span class="op">)</span>
<span class="co">#&gt;   x prob cumprob</span>
<span class="co">#&gt; 1 1 0.25    0.25</span>
<span class="co">#&gt; 2 2 0.25    0.50</span>
<span class="co">#&gt; 3 3 0.25    0.75</span>
<span class="co">#&gt; 4 4 0.25    1.00</span></code></code></pre></div>
</div>
<div id="other-distribution-functions" class="section level2">
<h2 class="hasAnchor">
<a href="#other-distribution-functions" class="anchor"></a>Other distribution functions</h2>
<p>Another important use case for <code>as_*()</code> functions is to convert some other distribution functions to be pdqr-functions. Except small number of special cases, output of <code>as_*()</code> function will have “continuous” type. The reason is because identifying exact values of distribution in discrete case is very hard in this setup (when almost nothing is known about the input function). It is assumed that if user knows those values, some <code>new_*()</code> function with data frame input can be used to create arbitrary “discrete” pdqr-function.</p>
<p>General conversion algorithm is as follows:</p>
<ul>
<li>If user didn’t supply support, detect it using algorithms targeted for every pdqr class separately. If <em>input function belongs to a certain set of “honored” distributions</em> (currently, it is all common univariate distributions <a href="https://rdrr.io/r/stats/Distributions.html">from ‘stats’ package</a>), support is detected in predefined way.</li>
<li>Using detected support, data frame input for corresponding <code>new_*()</code> function is created which approximates input function. Approximation precision can be tweaked with <code>n_grid</code> (and <code>n_sample</code> for <code><a href="../reference/as_p.html">as_r()</a></code>) argument: bigger values lead to better approximation precision, but worse memory usage and evaluation speed (direct and of <code>summ_*()</code> functions).</li>
</ul>
<div id="honored-distributions" class="section level3">
<h3 class="hasAnchor">
<a href="#honored-distributions" class="anchor"></a>Honored distributions</h3>
<p>For input distribution function to be recognized as “honored”, it should be supplied directly with its original name:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r"><code class = "r">
<code class="sourceCode R"><span class="co"># "Honored" distributions</span>
<span class="fu"><a href="../reference/as_p.html">as_d</a></span><span class="op">(</span><span class="va">dnorm</span><span class="op">)</span>
<span class="co">#&gt; Density function of continuous type</span>
<span class="co">#&gt; Support: ~[-4.75342, 4.75342] (10000 intervals)</span>

  <span class="co"># Underlying distribution doesn't depend on class ("p", "d", "q", "r").</span>
  <span class="co"># Following code has the same effect as `as_r(as_d(dnorm))`</span>
<span class="fu"><a href="../reference/as_p.html">as_r</a></span><span class="op">(</span><span class="va">rnorm</span><span class="op">)</span>
<span class="co">#&gt; Random generation function of continuous type</span>
<span class="co">#&gt; Support: ~[-4.75342, 4.75342] (10000 intervals)</span>

  <span class="co"># Different picewise-linear approximation precision is achieved with different</span>
  <span class="co"># `n_grid` argument value</span>
<span class="fu"><a href="../reference/as_p.html">as_d</a></span><span class="op">(</span><span class="va">dnorm</span>, n_grid <span class="op">=</span> <span class="fl">101</span><span class="op">)</span>
<span class="co">#&gt; Density function of continuous type</span>
<span class="co">#&gt; Support: ~[-4.75342, 4.75342] (100 intervals)</span>

  <span class="co"># Different extra arguments for input</span>
<span class="fu"><a href="../reference/as_p.html">as_d</a></span><span class="op">(</span><span class="va">dnorm</span>, mean <span class="op">=</span> <span class="fl">10</span>, sd <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>
<span class="co">#&gt; Density function of continuous type</span>
<span class="co">#&gt; Support: ~[9.52466, 10.47534] (10000 intervals)</span>

  <span class="co"># Currently only five distributions result into "discrete" output of `as_*()`</span>
<span class="fu"><a href="../reference/as_p.html">as_d</a></span><span class="op">(</span><span class="va">dbinom</span>, size <span class="op">=</span> <span class="fl">10</span>, prob <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span>
<span class="co">#&gt; Probability mass function of discrete type</span>
<span class="co">#&gt; Support: [0, 10] (11 elements)</span>
<span class="fu"><a href="../reference/as_p.html">as_d</a></span><span class="op">(</span><span class="va">dgeom</span>, prob <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span>
<span class="co">#&gt; Probability mass function of discrete type</span>
<span class="co">#&gt; Support: [0, 38] (39 elements)</span>
<span class="fu"><a href="../reference/as_p.html">as_d</a></span><span class="op">(</span><span class="va">dhyper</span>, m <span class="op">=</span> <span class="fl">10</span>, n <span class="op">=</span> <span class="fl">10</span>, k <span class="op">=</span> <span class="fl">7</span><span class="op">)</span>
<span class="co">#&gt; Probability mass function of discrete type</span>
<span class="co">#&gt; Support: [0, 7] (8 elements)</span>
<span class="fu"><a href="../reference/as_p.html">as_d</a></span><span class="op">(</span><span class="va">dnbinom</span>, size <span class="op">=</span> <span class="fl">10</span>, prob <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span>
<span class="co">#&gt; Probability mass function of discrete type</span>
<span class="co">#&gt; Support: [0, 87] (88 elements)</span>
<span class="fu"><a href="../reference/as_p.html">as_d</a></span><span class="op">(</span><span class="va">dpois</span>, lambda <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="co">#&gt; Probability mass function of discrete type</span>
<span class="co">#&gt; Support: [0, 9] (10 elements)</span>

<span class="co"># This isn't recognized as "honored", but output is very close to "honored"</span>
<span class="fu"><a href="../reference/as_p.html">as_d</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">}</span><span class="op">)</span>
<span class="co">#&gt; Density function of continuous type</span>
<span class="co">#&gt; Support: ~[-38.41642, 38.41642] (10000 intervals)</span></code></code></pre></div>
</div>
<div id="support-detection" class="section level3">
<h3 class="hasAnchor">
<a href="#support-detection" class="anchor"></a>Support detection</h3>
<p>Support detection is implemented for more smooth user experience. For more details on algorithms behind it, see section “Support detection” in <code><a href="../reference/as_p.html">as_p()</a></code> documentation. Generally, if you know exactly what support should be, it is better to provide it.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r"><code class = "r">
<code class="sourceCode R"><span class="va">my_d</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">x</span> <span class="op">&gt;=</span> <span class="op">-</span><span class="fl">1</span> <span class="op">&amp;</span> <span class="va">x</span> <span class="op">&lt;=</span> <span class="fl">1</span>, <span class="fl">0.75</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span><span class="op">}</span>

  <span class="co"># With default support detection</span>
<span class="fu"><a href="../reference/as_p.html">as_d</a></span><span class="op">(</span><span class="va">my_d</span><span class="op">)</span>
<span class="co">#&gt; Density function of continuous type</span>
<span class="co">#&gt; Support: ~[-1.00018, 1.00019] (7588 intervals)</span>

  <span class="co"># Providing custom, maybe only partially known, support</span>
<span class="fu"><a href="../reference/as_p.html">as_d</a></span><span class="op">(</span><span class="va">my_d</span>, support <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Density function of continuous type</span>
<span class="co">#&gt; Support: ~[-1, 1.00007] (9327 intervals)</span>
<span class="fu"><a href="../reference/as_p.html">as_d</a></span><span class="op">(</span><span class="va">my_d</span>, support <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Density function of continuous type</span>
<span class="co">#&gt; Support: ~[-1.0002, 1] (8027 intervals)</span>
<span class="fu"><a href="../reference/as_p.html">as_d</a></span><span class="op">(</span><span class="va">my_d</span>, support <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Density function of continuous type</span>
<span class="co">#&gt; Support: [-1, 1] (10000 intervals)</span></code></code></pre></div>
<p>Here is a comparison of support detection performance. One important note here is that algorithm has random nature in <code><a href="../reference/as_p.html">as_r()</a></code> (which is reasonable because the only information available about distribution is its random generation function).</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r"><code class = "r">
<code class="sourceCode R"><span class="op">(</span><span class="va">p_norm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as_p.html">as_p</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">pnorm</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">}</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Cumulative distribution function of continuous type</span>
<span class="co">#&gt; Support: ~[-4.75343, 4.75342] (10000 intervals)</span>
<span class="op">(</span><span class="va">d_norm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as_p.html">as_d</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">}</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Density function of continuous type</span>
<span class="co">#&gt; Support: ~[-38.41642, 38.41642] (10000 intervals)</span>
<span class="op">(</span><span class="va">q_norm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as_p.html">as_q</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">qnorm</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">}</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Quantile function of continuous type</span>
<span class="co">#&gt; Support: ~[-3.89971, 3.89971] (8204 intervals)</span>
<span class="op">(</span><span class="va">r_norm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as_p.html">as_r</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">}</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Random generation function of continuous type</span>
<span class="co">#&gt; Support: ~[-3.91006, 3.82021] (10000 intervals)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span>
  <span class="fu"><a href="../reference/as_p.html">as_d</a></span><span class="op">(</span><span class="va">p_norm</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"black"</span>,
  main <span class="op">=</span> <span class="st">"Comparison of `as_*()` functions support detection"</span>
<span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="va">d_norm</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="fu"><a href="../reference/as_p.html">as_d</a></span><span class="op">(</span><span class="va">q_norm</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="fu"><a href="../reference/as_p.html">as_d</a></span><span class="op">(</span><span class="va">r_norm</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"green"</span><span class="op">)</span></code></code></pre></div>
<p><img src="pdqr-02-convert_files/figure-html/support-detection_performance-1.png" width="700"></p>
</div>
<div id="infinity-imputation" class="section level3">
<h3 class="hasAnchor">
<a href="#infinity-imputation" class="anchor"></a>Infinity imputation</h3>
<p>If for some point density function goes to infinity, it is imputed linearly from its neighborhood. For not “honored” distribution functions, it can be more robust to use <code><a href="../reference/as_p.html">as_p()</a></code> for initial conversion.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r"><code class = "r">
<code class="sourceCode R"><span class="va">x_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.06</span>, by <span class="op">=</span> <span class="fl">1e-5</span><span class="op">)</span>

<span class="co"># "Honored" distribution</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span>
  <span class="fu"><a href="../reference/as_p.html">as_d</a></span><span class="op">(</span><span class="va">dchisq</span>, df <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"black"</span>,
  xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.05</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">20</span><span class="op">)</span>,
  main <span class="op">=</span> <span class="st">"Infinity imputation for Chi-squared distribution"</span>
<span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="va">x_grid</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Chisquare.html">dchisq</a></span><span class="op">(</span><span class="va">x_grid</span>, df <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></code></code></pre></div>
<p><img src="pdqr-02-convert_files/figure-html/support_detection_infinity-1.png" width="700"></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r"><code class = "r">
<code class="sourceCode R">
<span class="co"># Custom function</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span>
  <span class="fu"><a href="../reference/as_p.html">as_d</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">}</span>, support <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"black"</span>,
  xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.001</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">6</span>, <span class="fl">12</span><span class="op">)</span>,
  main <span class="op">=</span> <span class="st">"Infinity imputation for custom function"</span>
<span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="va">x_grid</span>, <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">x_grid</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></code></code></pre></div>
<p><img src="pdqr-02-convert_files/figure-html/support_detection_infinity-2.png" width="700"></p>
</div>
</div>
<div id="approximation-error" class="section level2">
<h2 class="hasAnchor">
<a href="#approximation-error" class="anchor"></a>Approximation error</h2>
<p><strong>Note</strong> that output distribution is usually an approximation (albeit a reasonably good one) of input due to the following facts:</p>
<ul>
<li>Output density has piecewise-linear nature, which is almost never the case for input function.</li>
<li>Possible infinite tails are removed to obtain finite support. Usually output support “loses” only around 1e-6 probability on each infinite tail.</li>
<li>Possible infinite values of density are linearly approximated from neighborhood points.</li>
</ul>
<p>‘pdqr’ provides a diagnostic function <code><a href="../reference/pdqr_approx_error.html">pdqr_approx_error()</a></code> to look at the precision of approximation. It accepts a pdqr-function and original reference distribution function with its possible extra arguments. It constructs a grid that is more dense than “x” column in pdqr-function’s “x_tbl” metadata (to actually test the precision of piecewise-linear nature). Output is a data frame with rows corresponding to that grid elements and columns with two kinds of errors: “error” (with direct, signed error as difference between values of reference function and pdqr-function) and “abserror” (with absolute error):</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r"><code class = "r">
<code class="sourceCode R"><span class="va">approx_err</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pdqr_approx_error.html">pdqr_approx_error</a></span><span class="op">(</span><span class="fu"><a href="../reference/as_p.html">as_d</a></span><span class="op">(</span><span class="va">dnorm</span>, sd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>, <span class="va">dnorm</span>, sd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">approx_err</span><span class="op">)</span>
<span class="co">#&gt;        grid         error     abserror</span>
<span class="co">#&gt; 1 -9.506849 -4.948351e-12 4.948351e-12</span>
<span class="co">#&gt; 2 -9.506658 -7.126907e-12 7.126907e-12</span>
<span class="co">#&gt; 3 -9.506468 -8.822366e-12 8.822366e-12</span>
<span class="co">#&gt; 4 -9.506278 -1.003453e-11 1.003453e-11</span>
<span class="co">#&gt; 5 -9.506088 -1.076320e-11 1.076320e-11</span>
<span class="co">#&gt; 6 -9.505898 -1.100818e-11 1.100818e-11</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">approx_err</span><span class="op">)</span>
<span class="co">#&gt;       grid            error               abserror        </span>
<span class="co">#&gt;  Min.   :-9.507   Min.   :-3.989e-07   Min.   :4.900e-12  </span>
<span class="co">#&gt;  1st Qu.:-4.753   1st Qu.:-2.000e-07   1st Qu.:9.874e-10  </span>
<span class="co">#&gt;  Median : 0.000   Median :-2.776e-08   Median :2.776e-08  </span>
<span class="co">#&gt;  Mean   : 0.000   Mean   :-1.052e-07   Mean   :1.052e-07  </span>
<span class="co">#&gt;  3rd Qu.: 4.753   3rd Qu.:-9.874e-10   3rd Qu.:2.000e-07  </span>
<span class="co">#&gt;  Max.   : 9.507   Max.   :-4.900e-12   Max.   :3.989e-07</span></code></code></pre></div>
<p>Here are estimation of median and maximum errors for most common “honored” distributions using default <code>n_grid</code> value (tested for d-functions, but can be used also for p- and q-functions):</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r"><code class = "r">
<code class="sourceCode R"><span class="va">abserror_stat</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">f</span>, <span class="va">ref_f</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">approx_err</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pdqr_approx_error.html">pdqr_approx_error</a></span><span class="op">(</span><span class="va">f</span>, <span class="va">ref_f</span>, <span class="va">...</span><span class="op">)</span>
  
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
    median_abserror <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">approx_err</span><span class="op">[[</span><span class="st">"abserror"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,
    max_abserror <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">approx_err</span><span class="op">[[</span><span class="st">"abserror"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">}</span>

<span class="va">abserror_stat_fin</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">f</span>, <span class="va">ref_f</span>, <span class="va">grid</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">abserror</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="fu">f</span><span class="op">(</span><span class="va">grid</span><span class="op">)</span> <span class="op">-</span> <span class="fu">ref_f</span><span class="op">(</span><span class="va">grid</span>, <span class="va">...</span><span class="op">)</span><span class="op">)</span>
  
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>median_abserror <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">abserror</span><span class="op">)</span>, max_abserror <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">abserror</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># Normal</span>
<span class="fu">abserror_stat</span><span class="op">(</span><span class="fu"><a href="../reference/as_p.html">as_d</a></span><span class="op">(</span><span class="va">dnorm</span><span class="op">)</span>, <span class="va">dnorm</span><span class="op">)</span>
<span class="co">#&gt; median_abserror    max_abserror </span>
<span class="co">#&gt;    5.551817e-08    7.978876e-07</span>

<span class="co"># Beta</span>
<span class="fu">abserror_stat</span><span class="op">(</span>
  <span class="fu"><a href="../reference/as_p.html">as_d</a></span><span class="op">(</span><span class="va">dbeta</span>, shape1 <span class="op">=</span> <span class="fl">10</span>, shape2 <span class="op">=</span> <span class="fl">20</span><span class="op">)</span>, <span class="va">dbeta</span>, shape1 <span class="op">=</span> <span class="fl">10</span>, shape2 <span class="op">=</span> <span class="fl">20</span>
<span class="op">)</span>
<span class="co">#&gt; median_abserror    max_abserror </span>
<span class="co">#&gt;    1.270044e-06    9.263838e-06</span>

  <span class="co"># By default, `pdqr_approx_error()` removes infinity errors. As one can see,</span>
  <span class="co"># when density goes to infinity, error can be quite big</span>
<span class="fu">abserror_stat</span><span class="op">(</span>
  <span class="fu"><a href="../reference/as_p.html">as_d</a></span><span class="op">(</span><span class="va">dbeta</span>, shape1 <span class="op">=</span> <span class="fl">0.1</span>, shape2 <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span>, <span class="va">dbeta</span>, shape1 <span class="op">=</span> <span class="fl">0.1</span>, shape2 <span class="op">=</span> <span class="fl">0.2</span>
<span class="op">)</span>
<span class="co">#&gt; median_abserror    max_abserror </span>
<span class="co">#&gt;        0.108998     1630.863871</span>

<span class="co"># Exponential</span>
<span class="fu">abserror_stat</span><span class="op">(</span><span class="fu"><a href="../reference/as_p.html">as_d</a></span><span class="op">(</span><span class="va">dexp</span>, rate <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>, <span class="va">dexp</span>, rate <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>
<span class="co">#&gt; median_abserror    max_abserror </span>
<span class="co">#&gt;    9.953929e-09    1.078784e-05</span>

<span class="co"># Student</span>
<span class="fu">abserror_stat</span><span class="op">(</span><span class="fu"><a href="../reference/as_p.html">as_d</a></span><span class="op">(</span><span class="va">dt</span>, df <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>, <span class="va">dt</span>, df <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>
<span class="co">#&gt; median_abserror    max_abserror </span>
<span class="co">#&gt;    2.984622e-11    7.626976e-07</span>

<span class="co"># Cauchy. Heavy tails also affect approximation error</span>
<span class="fu">abserror_stat</span><span class="op">(</span><span class="fu"><a href="../reference/as_p.html">as_d</a></span><span class="op">(</span><span class="va">dcauchy</span><span class="op">)</span>, <span class="va">dcauchy</span><span class="op">)</span>
<span class="co">#&gt; median_abserror    max_abserror </span>
<span class="co">#&gt;    2.518228e-08    6.378956e-04</span>

<span class="co"># Poisson. Pdqr-function isn't exact because of tail trimming.</span>
<span class="fu">abserror_stat_fin</span><span class="op">(</span><span class="fu"><a href="../reference/as_p.html">as_d</a></span><span class="op">(</span><span class="va">dpois</span>, lambda <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>, <span class="va">dpois</span>, grid <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">30</span>, lambda <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>
<span class="co">#&gt; median_abserror    max_abserror </span>
<span class="co">#&gt;    9.757657e-09    5.134715e-07</span>

<span class="co"># For some distributions functions are exact</span>
<span class="co"># Uniform</span>
<span class="fu">abserror_stat</span><span class="op">(</span><span class="fu"><a href="../reference/as_p.html">as_d</a></span><span class="op">(</span><span class="va">dunif</span><span class="op">)</span>, <span class="va">dunif</span><span class="op">)</span>
<span class="co">#&gt; median_abserror    max_abserror </span>
<span class="co">#&gt;               0               0</span>

<span class="co"># Binomial</span>
<span class="fu">abserror_stat_fin</span><span class="op">(</span>
  <span class="fu"><a href="../reference/as_p.html">as_d</a></span><span class="op">(</span><span class="va">dbinom</span>, size <span class="op">=</span> <span class="fl">10</span>, prob <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span>, <span class="va">dbinom</span>, grid <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">10</span>,
  size <span class="op">=</span> <span class="fl">10</span>, prob <span class="op">=</span> <span class="fl">0.1</span>
<span class="op">)</span>
<span class="co">#&gt; median_abserror    max_abserror </span>
<span class="co">#&gt;               0               0</span></code></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Evgeni Chasnovski.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
